-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Table 1:
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    date_of_birth DATE NOT NULL,
    gender VARCHAR(20) NOT NULL,
    phone VARCHAR(20) UNIQUE,
    bio TEXT,
    profile_photo_url TEXT,
    cover_photo_url TEXT,
    auth_provider VARCHAR(50) NOT NULL,
    auth_provider_id VARCHAR(255),
    email_verified BOOLEAN DEFAULT false,
    phone_verified BOOLEAN DEFAULT false,
    id_verified BOOLEAN DEFAULT false,
    profile_complete BOOLEAN DEFAULT false,
    last_active TIMESTAMP,
    is_online BOOLEAN DEFAULT false,
    account_status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_age CHECK (age >= 18 AND age <= 100),
    CONSTRAINT check_gender CHECK (gender IN ('male', 'female', 'prefer_not_to_say')),
    CONSTRAINT check_auth_provider CHECK (auth_provider IN ('local', 'google')),
    CONSTRAINT check_account_status CHECK (account_status IN ('active', 'suspended', 'deleted'))
);

CREATE INDEX idx_users_auth_provider ON users(auth_provider, auth_provider_id);
CREATE INDEX idx_users_account_status ON users(account_status);

-- Table 2:
CREATE TABLE user_locations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    city VARCHAR(255) NOT NULL,
    country VARCHAR(255) NOT NULL,
    country_code VARCHAR(3) NOT NULL,
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    is_current BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_user_locations_unique_current ON user_locations (user_id, city, country) WHERE is_current = true;
CREATE INDEX idx_user_locations_user_id ON user_locations(user_id);
CREATE INDEX idx_user_locations_country ON user_locations(country_code);
-- Note: Standard Postgres doesn't have a "SPATIAL" keyword; use GiST if installing PostGIS
CREATE INDEX idx_user_locations_coordinates ON user_locations(latitude, longitude);

-- Table 3:
CREATE TABLE interests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) UNIQUE NOT NULL,
    category VARCHAR(50) NOT NULL,
    icon VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_category CHECK (category IN ('adventure', 'culture', 'food', 'nature', 'nightlife', 'wellness', 'other'))
);

CREATE INDEX idx_interests_category ON interests(category);

-- Table 4:
CREATE TABLE user_interests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    interest_id UUID NOT NULL REFERENCES interests(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_user_interest UNIQUE (user_id, interest_id)
);

CREATE INDEX idx_user_interests_user_id ON user_interests(user_id);
CREATE INDEX idx_user_interests_interest_id ON user_interests(interest_id);

-- Table 5:
CREATE TABLE user_languages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    language_code VARCHAR(10) NOT NULL,
    language_name VARCHAR(100) NOT NULL,
    proficiency VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_user_language UNIQUE (user_id, language_code),
    CONSTRAINT check_proficiency CHECK (proficiency IN ('basic', 'intermediate', 'fluent', 'native'))
);

CREATE INDEX idx_user_languages_user_id ON user_languages(user_id);
CREATE INDEX idx_user_languages_code ON user_languages(language_code);

-- Table 6:
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    budget_min DECIMAL(10, 2) NOT NULL,
    budget_max DECIMAL(10, 2) NOT NULL,
    budget_currency VARCHAR(3) DEFAULT 'USD',
    travel_style VARCHAR(20) NOT NULL,
    group_size_preference VARCHAR(20) NOT NULL,
    accommodation_types JSONB,
    smoking_preference VARCHAR(20) DEFAULT 'no_preference',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_budget CHECK (budget_min >= 0 AND budget_max > budget_min),
    CONSTRAINT check_travel_style CHECK (travel_style IN ('relaxed', 'balanced', 'fast_paced')),
    CONSTRAINT check_group_size CHECK (group_size_preference IN ('solo', 'small', 'medium', 'large', 'flexible')),
    CONSTRAINT check_smoking CHECK (smoking_preference IN ('smoker', 'non_smoker', 'no_preference'))
);

CREATE INDEX idx_user_preferences_budget ON user_preferences(budget_min, budget_max);

-- Table 7:
CREATE TABLE user_statistics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    trips_completed INTEGER DEFAULT 0,
    countries_visited INTEGER DEFAULT 0,
    cities_explored INTEGER DEFAULT 0,
    travel_buddies_met INTEGER DEFAULT 0,
    total_distance_km DECIMAL(10, 2) DEFAULT 0,
    total_days_traveled INTEGER DEFAULT 0,
    average_rating DECIMAL(3, 2) DEFAULT 0.0,
    review_count INTEGER DEFAULT 0,
    connection_count INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_rating CHECK (average_rating >= 0 AND average_rating <= 5),
    CONSTRAINT check_trips CHECK (trips_completed >= 0)
);

-- Table 8:
CREATE TABLE email_verifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    email VARCHAR(255) NOT NULL,
    verification_code VARCHAR(10) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    verified BOOLEAN DEFAULT false,
    verified_at TIMESTAMP,
    attempts INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_attempts CHECK (attempts <= 5)
);

CREATE INDEX idx_email_verifications_email ON email_verifications(email);
CREATE INDEX idx_email_verifications_code ON email_verifications(verification_code, email);
CREATE INDEX idx_email_verifications_expires ON email_verifications(expires_at);

-- Table 9: 
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT false,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_password_reset_user_id ON password_reset_tokens(user_id);
CREATE INDEX idx_password_reset_expires ON password_reset_tokens(expires_at);

-- Table 10:
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token TEXT UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    revoked BOOLEAN DEFAULT false,
    revoked_at TIMESTAMP,
    device_info JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_token ON refresh_tokens(token);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);

-- Table 11: 
CREATE TABLE trip_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    destination_city VARCHAR(255) NOT NULL,
    destination_country VARCHAR(255) NOT NULL,
    destination_country_code VARCHAR(3) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    flexible_dates BOOLEAN DEFAULT false,
    date_flexibility_days INTEGER DEFAULT 0,
    budget_amount DECIMAL(10, 2) NOT NULL,
    budget_currency VARCHAR(3) DEFAULT 'USD',
    status VARCHAR(20) DEFAULT 'active',
    notify_on_match BOOLEAN DEFAULT true,
    last_match_check TIMESTAMP,
    match_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_trip_dates CHECK (end_date > start_date),
    CONSTRAINT check_budget_amount CHECK (budget_amount > 0),
    CONSTRAINT check_trip_status CHECK (status IN ('active', 'paused', 'closed', 'expired'))
);

CREATE INDEX idx_trip_requests_user_id ON trip_requests(user_id);
CREATE INDEX idx_trip_requests_destination ON trip_requests(destination_city, destination_country_code);
CREATE INDEX idx_trip_requests_dates ON trip_requests(start_date, end_date);
CREATE INDEX idx_trip_requests_status ON trip_requests(status);
CREATE INDEX idx_trip_requests_active ON trip_requests(status, start_date) WHERE status = 'active';

-- Table 12:
CREATE TABLE trip_request_preferences (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    trip_request_id UUID UNIQUE NOT NULL REFERENCES trip_requests(id) ON DELETE CASCADE,
    age_min INTEGER,
    age_max INTEGER,
    gender_preference JSONB,
    verified_only BOOLEAN DEFAULT false,
    similar_interests_importance VARCHAR(20) DEFAULT 'medium',
    similar_budget_importance VARCHAR(20) DEFAULT 'medium',
    same_travel_style BOOLEAN DEFAULT false,
    max_group_size INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_pref_age CHECK (age_min >= 18 AND age_max <= 100),
    CONSTRAINT check_age_range CHECK (age_min <= age_max)
);

-- Table 13:
CREATE TABLE connections (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user1_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    user2_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL,
    initiated_by UUID NOT NULL REFERENCES users(id),
    message TEXT,
    trip_request_id UUID REFERENCES trip_requests(id) ON DELETE SET NULL,
    accepted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_different_users CHECK (user1_id != user2_id),
    CONSTRAINT check_user_order CHECK (user1_id < user2_id),
    CONSTRAINT unique_connection_pair UNIQUE (user1_id, user2_id),
    CONSTRAINT check_conn_status CHECK (status IN ('pending', 'accepted', 'declined', 'blocked'))
);

CREATE INDEX idx_connections_user1 ON connections(user1_id, status);
CREATE INDEX idx_connections_user2 ON connections(user2_id, status);
CREATE INDEX idx_connections_status ON connections(status);

-- Table 14: 
CREATE TABLE blocked_users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    blocker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    blocked_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    reason VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_block_pair UNIQUE (blocker_id, blocked_id)
);

CREATE INDEX idx_blocked_users_blocker ON blocked_users(blocker_id);

-- Table 15:
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    type VARCHAR(20) NOT NULL,
    name VARCHAR(255),
    created_by UUID REFERENCES users(id) ON DELETE SET NULL,
    trip_plan_id UUID, -- References travel_plans(id)
    last_message_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT check_conv_type CHECK (type IN ('individual', 'group'))
);

CREATE INDEX idx_conversations_type ON conversations(type);
CREATE INDEX idx_conversations_last_message ON conversations(last_message_at DESC);

-- Table 16:
CREATE TABLE conversation_participants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member',
    joined_at TIMESTAMP DEFAULT NOW(),
    last_read_at TIMESTAMP,
    last_read_message_id UUID,
    muted BOOLEAN DEFAULT false,
    CONSTRAINT unique_conv_participant UNIQUE (conversation_id, user_id)
);

CREATE INDEX idx_conversation_participants_user ON conversation_participants(user_id);
CREATE INDEX idx_conversation_participants_conversation ON conversation_participants(conversation_id);

